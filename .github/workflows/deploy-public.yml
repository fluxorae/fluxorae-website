name: Deploy Public (fluxorae.com)

on:
  push:
    branches: [main]
    paths:
      - "apps/public/**"
      - "package.json"
      - "package-lock.json"
      - ".github/workflows/deploy-public.yml"
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to deploy"
        required: false
        default: "main"

concurrency:
  group: deploy-public-${{ github.ref }}
  cancel-in-progress: true

env:
  AMPLIFY_APP_ID: d2xl5a4ri11ava
  AWS_DEPLOY_ROLE_ARN: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
  NODE_VERSION: 20
  AWS_REGION: ${{ vars.AWS_REGION || 'eu-north-1' }}
  NEXT_TELEMETRY_DISABLED: 1
  NEXT_PUBLIC_BASE_URL: https://fluxorae.com
  CONTACT_EMAIL: info@fluxorae.com
  SKIP_DB: 1

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build (public)
        run: npm run build:public

      - name: Configure AWS credentials
        if: env.AWS_DEPLOY_ROLE_ARN != ''
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          role-session-name: github-amplify-deploy
          aws-region: ${{ env.AWS_REGION }}

      - name: Trigger Amplify deploy
        if: env.AWS_DEPLOY_ROLE_ARN != ''
        env:
          AMPLIFY_BRANCH: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.branch || github.ref_name }}
        run: |
          echo "Starting Amplify job for app ${AMPLIFY_APP_ID} on branch ${AMPLIFY_BRANCH}"
          aws amplify start-job \
            --app-id "${AMPLIFY_APP_ID}" \
            --branch-name "${AMPLIFY_BRANCH}" \
            --job-type RELEASE

      - name: Skip deploy (missing AWS_DEPLOY_ROLE_ARN)
        if: env.AWS_DEPLOY_ROLE_ARN == ''
        run: echo "AWS_DEPLOY_ROLE_ARN not set; skipping Amplify trigger."
