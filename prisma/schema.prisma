// Prisma schema for Fluxorae Digital Ecosystem
// DB: PostgreSQL (AWS RDS)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN
  ADMIN
  EMPLOYEE
  CLIENT
  FREELANCER
  PARTNER
}

enum Status {
  ACTIVE
  INACTIVE
  SUSPENDED
  ARCHIVED
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String
  role          Role     @default(CLIENT)
  status        Status   @default(ACTIVE)
  firstName     String?
  lastName      String?
  phone         String?
  mfaEnabled    Boolean  @default(false)
  sessions      Session[]
  auditLogs     AuditLog[]
  clients       Client[] @relation("ClientOwner")
  employees     Employee?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Session {
  id         String   @id @default(cuid())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String
  refreshJwt String   @unique
  expiresAt  DateTime
  createdAt  DateTime @default(now())
}

model Client {
  id         String    @id @default(cuid())
  name       String
  owner      User      @relation("ClientOwner", fields: [ownerId], references: [id])
  ownerId    String
  contacts   Json?
  projects   Project[]
  invoices   Invoice[]
  tickets    Ticket[]
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}

model Employee {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String   @unique
  title     String?
  reportsTo String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Project {
  id          String      @id @default(cuid())
  name        String
  description String?
  status      String      @default("ACTIVE")
  client      Client      @relation(fields: [clientId], references: [id])
  clientId    String
  owner       User?       @relation(fields: [ownerId], references: [id])
  ownerId     String?
  milestones  Milestone[]
  tasks       Task[]
  tickets     Ticket[]
  invoices    Invoice[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model Milestone {
  id        String   @id @default(cuid())
  title     String
  status    String   @default("PLANNED")
  dueDate   DateTime?
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Task {
  id         String    @id @default(cuid())
  title      String
  status     String    @default("TODO")
  orderIndex Int       @default(0)
  project    Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId  String
  assignee   User?     @relation(fields: [assigneeId], references: [id])
  assigneeId String?
  metadata   Json?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}

model Ticket {
  id        String   @id @default(cuid())
  title     String
  status    String   @default("OPEN")
  priority  String   @default("NORMAL")
  project   Project? @relation(fields: [projectId], references: [id])
  projectId String?
  client    Client?  @relation(fields: [clientId], references: [id])
  clientId  String?
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Invoice {
  id         String    @id @default(cuid())
  number     String    @unique
  amount     Decimal   @db.Numeric(14, 2)
  currency   String    @default("INR")
  gstPercent Decimal   @db.Numeric(5, 2) @default(0)
  status     String    @default("DRAFT")
  project    Project?  @relation(fields: [projectId], references: [id])
  projectId  String?
  client     Client    @relation(fields: [clientId], references: [id])
  clientId   String
  payments   Payment[]
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}

model Payment {
  id          String   @id @default(cuid())
  provider    String
  amount      Decimal  @db.Numeric(14, 2)
  currency    String   @default("INR")
  status      String   @default("PENDING")
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  invoiceId   String
  providerRef String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model AuditLog {
  id        String   @id @default(cuid())
  actor     User?    @relation(fields: [actorId], references: [id])
  actorId   String?
  action    String
  entity    String
  entityId  String?
  metadata  Json?
  createdAt DateTime @default(now())
}
